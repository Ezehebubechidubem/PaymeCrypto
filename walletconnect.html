<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WalletConnect | Payme Crypto</title>

  <!-- WalletConnect Ethereum Provider (UMD) -->
  <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.11.0/dist/umd/index.min.js"></script>
  <!-- Ethers (UMD) -->
  <script src="https://unpkg.com/ethers@6.6.0/dist/ethers.umd.min.js"></script>

  <style>
    :root {
      --bg: linear-gradient(180deg,#031620,#072a34);
      --text: #ecf9f2;
      --accent: #00d27a;
      --muted: #96b1ad;
      --card-bg: rgba(255,255,255,0.04);
    }
    html,body { height:100%; margin:0; font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial; }
    body{
      background: var(--bg);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .card {
      width:100%;
      max-width:520px;
      background: var(--card-bg);
      border-radius:14px;
      padding:22px;
      box-shadow:0 10px 30px rgba(0,0,0,0.55);
      text-align:center;
    }
    h1 { margin:0 0 8px 0; color:var(--accent); font-size:20px; }
    p.lead { margin:0 0 18px 0; color:var(--muted); font-size:13px; }
    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:12px 16px;
      border-radius:10px;
      border:0;
      background:var(--accent);
      color:#042e21;
      font-weight:700;
      cursor:pointer;
      font-size:15px;
    }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    #status {
      margin-top:14px;
      color:var(--muted);
      word-break:break-word;
      font-size:13px;
    }
    .meta { margin-top:12px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    .chip { background: rgba(255,255,255,0.02); padding:8px 10px; border-radius:8px; font-size:13px; color:var(--muted); }
    small.hint { display:block; margin-top:10px; color:#cfeee0; font-size:12px; opacity:0.9; }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">Connect with WalletConnect</h1>
    <p class="lead">Use WalletConnect to link a mobile/desktop wallet (MetaMask Mobile, OKX, Trust Wallet, Rainbow, etc.).</p>

    <button id="connectBtn" class="btn" aria-live="polite">Connect Wallet</button>

    <div id="status">Status: not connected</div>

    <div class="meta" id="meta"></div>

    <small class="hint">Project ID is already pre-filled in this build. If you change it, clear localStorage and reload.</small>
  </div>

  <script>
  (async function () {
    // ====== CONFIG (your Project ID) ======
    const PROJECT_ID = "48a4f7dc44d18bf848a1128ae145eb89"; // <- your WalletConnect Cloud Project ID

    // Chains to advertise (common EVM chains). Add or remove as needed.
    const CHAINS = [
      1,    // Ethereum Mainnet
      56,   // BSC
      137,  // Polygon
      43114,// Avalanche
      10,   // Optimism
      42161,// Arbitrum
      250,  // Fantom
      25,   // Cronos
      42220 // Celo (example)
    ];

    // ====== UI Refs ======
    const connectBtn = document.getElementById("connectBtn");
    const statusEl = document.getElementById("status");
    const metaEl = document.getElementById("meta");

    function setStatus(txt, important=false) {
      statusEl.textContent = "Status: " + txt;
      if (important) {
        statusEl.style.color = "#fff";
      } else {
        statusEl.style.color = "";
      }
      console.debug("[walletconnect] " + txt);
    }

    function showMeta(k, v) {
      // small chip for showing address/chain
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.innerText = `${k}: ${v}`;
      metaEl.appendChild(chip);
    }
    function clearMeta() { metaEl.innerHTML = ""; }

    // ====== Guard: ensure UMD script exposed expected global ======
    const globalProviderCtor = window.EthereumProvider || window.WalletConnectProvider || null;
    if (!globalProviderCtor) {
      setStatus("WalletConnect provider script did not load (check network or CDN).", true);
      connectBtn.disabled = true;
      console.error("WalletConnect UMD not found on window. Window keys:", Object.keys(window).filter(k=>/wallet|ethereum|Wallet/i.test(k)));
      return;
    }

    // ====== Initialize provider (do not connect yet) ======
    let provider;
    try {
      setStatus("Initializing WalletConnect provider...");
      provider = await globalProviderCtor.init({
        projectId: PROJECT_ID,
        chains: CHAINS,
        showQrModal: true,      // provider will show QR/modal when connect() is called
        // Optional: you can restrict methods or add rpcMap if you have custom RPCs
        // rpcMap: { 1: "https://your-eth-rpc", 137: "https://rpc.ankr.com/polygon" }
      });
      setStatus("Provider initialized (ready).");
    } catch (e) {
      setStatus("Failed to initialize WalletConnect provider: " + (e.message || e), true);
      console.error(e);
      connectBtn.disabled = true;
      return;
    }

    // ====== Helper: is connected? ======
    function isConnectedSession() {
      try {
        return !!(provider && provider.session && provider.session.connected);
      } catch (_) { return false; }
    }

    // Restore UI if already connected session exists
    if (isConnectedSession()) {
      setStatus("Already connected (active session).");
      connectBtn.textContent = "Disconnect";
      // try to display current account(s)
      try {
        const accts = (provider.session.accounts && provider.session.accounts.length) ? provider.session.accounts : [];
        if (accts.length) {
          clearMeta();
          showMeta("Account", accts[0]);
          showMeta("Namespace", provider.session.namespaces ? Object.keys(provider.session.namespaces).join(",") : "evm");
        }
      } catch (e) { /* ignore */ }
    }

    // ====== Connect flow ======
    async function connectWallet() {
      setStatus("Opening connection (WalletConnect modal)...");
      connectBtn.disabled = true;
      try {
        await provider.connect(); // will open modal/QR if required

        // after connect, request accounts & chain
        let accounts = [];
        try {
          // eth_accounts is safe and non-blocking
          accounts = await provider.request({ method: "eth_accounts" });
        } catch (e) {
          console.warn("eth_accounts failed, trying request accounts via rpc:", e);
          try { accounts = await provider.request({ method: "eth_requestAccounts" }); } catch(e2){ console.warn(e2); }
        }

        // chainId might be hex ("0x1")
        let chainId;
        try {
          chainId = await provider.request({ method: "eth_chainId" });
        } catch (e) {
          console.warn("eth_chainId failed:", e);
        }

        if (!accounts || !accounts.length) {
          setStatus("Connected but no accounts returned.");
          connectBtn.disabled = false;
          return;
        }

        const addr = accounts[0];
        setStatus("Connected: " + addr);
        clearMeta();
        showMeta("Account", addr);
        showMeta("Chain", chainId ? (parseInt(chainId,16) || chainId) : "unknown");

        // persist to localStorage so dashboard can pick it up
        localStorage.setItem("payme_walletconnect", JSON.stringify({
          address: addr,
          chainId: chainId,
          connectedAt: Date.now()
        }));

        // flip UI
        connectBtn.textContent = "Disconnect";
        connectBtn.disabled = false;

        // delay then redirect to dashboard
        setTimeout(()=> { try { window.location.href = "dashboard.html"; } catch(e){} }, 800);

      } catch (err) {
        console.error("Connect failed:", err);
        setStatus("Connection error: " + (err && err.message ? err.message : err), true);
        connectBtn.disabled = false;
      }
    }

    async function disconnectWallet() {
      try {
        setStatus("Disconnecting...");
        connectBtn.disabled = true;
        await provider.disconnect();
      } catch (e) {
        console.warn("Disconnect call failed (may already be disconnected):", e);
      } finally {
        localStorage.removeItem("payme_walletconnect");
        clearMeta();
        setStatus("Disconnected");
        connectBtn.textContent = "Connect Wallet";
        connectBtn.disabled = false;
      }
    }

    // ====== Button events ======
    connectBtn.addEventListener("click", async () => {
      if (!provider) {
        setStatus("Provider not ready.", true);
        return;
      }
      if (isConnectedSession()) {
        await disconnectWallet();
      } else {
        await connectWallet();
      }
    });

    // ====== Events from provider ======
    try {
      provider.on && provider.on("accountsChanged", (acc) => {
        setStatus("Account changed: " + (acc && acc[0] ? acc[0] : "none"));
        clearMeta();
        if (acc && acc[0]) showMeta("Account", acc[0]);
        // update persisted storage
        const saved = JSON.parse(localStorage.getItem("payme_walletconnect") || "{}");
        saved.address = acc && acc[0] ? acc[0] : null;
        localStorage.setItem("payme_walletconnect", JSON.stringify(saved));
      });

      provider.on && provider.on("chainChanged", (chain) => {
        setStatus("Chain changed: " + chain);
        clearMeta();
        showMeta("Chain", chain);
        const saved = JSON.parse(localStorage.getItem("payme_walletconnect") || "{}");
        saved.chainId = chain;
        localStorage.setItem("payme_walletconnect", JSON.stringify(saved));
      });

      provider.on && provider.on("disconnect", (reason) => {
        console.info("Provider disconnected:", reason);
        localStorage.removeItem("payme_walletconnect");
        clearMeta();
        setStatus("Disconnected");
        connectBtn.textContent = "Connect Wallet";
      });
    } catch (e) {
      console.warn("Failed to attach provider events:", e);
    }

    // final status
    setStatus(isConnectedSession() ? "Ready (connected)" : "Ready (not connected)");
  })();
  </script>
</body>
</html>