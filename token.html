<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Token Details — Payme Crypto</title>
  <style>
    body{font-family: "Segoe UI",sans-serif;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;min-height:100vh;padding:20px}
    .card{background:rgba(255,255,255,0.05);border-radius:12px;padding:18px;max-width:720px;margin:0 auto}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .muted{color:rgba(255,255,255,0.65)}
    .logo{width:48px;height:48px;border-radius:50%;object-fit:cover;margin-right:12px}
    .back{display:inline-block;margin-bottom:12px;color:#00ffae;text-decoration:none;font-weight:700}
    .up{color:#9fe6c8}.down{color:#ff7b7b}
  </style>
</head>
<body>
  <a class="back" href="index.html">&#8592; Back</a>
  <div class="card" id="detailCard">
    <div id="header" class="row" style="align-items:center">
      <div style="display:flex;align-items:center">
        <img id="logo" class="logo" src="" alt="" style="display:none"/>
        <div>
          <div id="sym" style="font-weight:800;font-size:20px">TOKEN</div>
          <div id="fullname" class="muted" style="font-size:13px">Full token name</div>
        </div>
      </div>
      <div style="text-align:right">
        <div id="usdvalue" style="font-weight:800;font-size:18px">$0.00</div>
        <div id="pct" class="muted">0.00%</div>
      </div>
    </div>

    <hr style="border:none;height:1px;background:rgba(255,255,255,0.04);margin:12px 0"/>

    <div class="row" style="margin-bottom:8px">
      <div class="muted">Wallet address</div>
      <div id="addr" class="muted" style="font-family:monospace">-</div>
    </div>

    <div class="row" style="margin-bottom:8px">
      <div class="muted">Amount</div>
      <div id="amount" style="font-weight:800">0</div>
    </div>

    <div class="row" style="margin-bottom:8px">
      <div class="muted">Price (USD)</div>
      <div id="price" class="muted">$0.00</div>
    </div>

    <div class="row" style="margin-bottom:8px">
      <div class="muted">USD value</div>
      <div id="value" style="font-weight:800">$0.00</div>
    </div>

    <div id="notes" style="margin-top:12px" class="muted"></div>
  </div>

  <script>
    const BACKEND_URL = "https://paymecrypto-1.onrender.com"; // same backend

    function fmt(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:8}); }

    // parse params
    const params = new URLSearchParams(window.location.search);
    const key = params.get("key"); // coinId or symbol
    const net = params.get("net") || "mainnet";
    const chainParam = params.get("chain") || "ethereum";
    document.getElementById("notes").innerText = `Network: ${net} • Preferred chain: ${chainParam}`;

    // try to get stored tokens for initial values
    const stored = JSON.parse(localStorage.getItem("payme_tokens") || "{}");
    let stored_meta = null;
    if(net === "mainnet"){
      stored_meta = (stored.mainnet && stored.mainnet[key]) ? stored.mainnet[key] : null;
    } else {
      stored_meta = (stored.testnet && stored.testnet[key]) ? stored.testnet[key] : null;
    }

    (async function loadDetail(){
      // show stored quick info if present
      if(stored_meta){
        document.getElementById("sym").innerText = stored_meta.symbol || key.toUpperCase();
        document.getElementById("fullname").innerText = stored_meta.name || key;
        document.getElementById("amount").innerText = (stored_meta.balance !== undefined) ? fmt(stored_meta.balance) + " " + (stored_meta.symbol || key.toUpperCase()) : "0";
        if(stored_meta.image){
          const img = document.getElementById("logo"); img.src = stored_meta.image; img.style.display = "inline-block";
        }
      } else {
        document.getElementById("sym").innerText = (key || "").toUpperCase();
        document.getElementById("fullname").innerText = "";
      }
      document.getElementById("addr").innerText = localStorage.getItem("payme_wallet") ? (JSON.parse(localStorage.getItem("payme_wallet")).address || "-") : "-";

      // call your backend to get fresh info
      try {
        const body = { chain: chainParam || "ethereum", address: (JSON.parse(localStorage.getItem("payme_wallet")||"{}").address||""), coin_ids: [] };
        // If key looks like a coingecko id (contains hyphen or lowercase letters), pass it; else pass as explicit token via contract array? We request coin_ids = [key] in most cases.
        if(net === "mainnet"){
          body.coin_ids = [key];
        } else {
          body.coin_ids = [];
        }
        const res = await fetch(BACKEND_URL + "/api/balance", {
          method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(body)
        });
        if(res.ok){
          const js = await res.json();
          // try to find the token entry matching key
          let entry = null;
          if(js.tokens && js.tokens.length>0){
            entry = js.tokens.find(t => (t.coin_id === key) || (t.symbol && t.symbol.toUpperCase() === key.toUpperCase()) || (t.contract && t.contract.toLowerCase() === key.toLowerCase()));
          }
          // also consider native
          if(!entry && js.native && (js.native.symbol && js.native.symbol.toUpperCase() === key.toUpperCase())){
            entry = {
              coin_id: null,
              symbol: js.native.symbol,
              name: js.native.symbol,
              contract: null,
              chain: js.chain,
              balance: js.native.balance,
              usd_price: js.native.usd_price,
              price_change_24h: js.native.price_change_24h,
              usd_value: js.native.usd_value,
              logo: null
            };
          }
          if(entry){
            document.getElementById("sym").innerText = (entry.symbol || key || "").toUpperCase();
            document.getElementById("fullname").innerText = entry.name || "";
            document.getElementById("amount").innerText = fmt(entry.balance || 0) + " " + (entry.symbol || "");
            document.getElementById("price").innerText = "$" + fmt(entry.usd_price || 0);
            document.getElementById("value").innerText = "$" + fmt(entry.usd_value || ((entry.balance||0)*(entry.usd_price||0)));
            const pctNode = document.getElementById("pct");
            const pct = entry.price_change_24h || 0;
            pctNode.innerText = (pct >= 0 ? "+" : "") + (Number(pct).toFixed(2)) + "%";
            pctNode.className = pct >= 0 ? "up" : "down";
            if(entry.logo){
              const img=document.getElementById("logo"); img.src = entry.logo; img.style.display="inline-block";
            }
          } else {
            // fallback: no token info returned
            document.getElementById("notes").innerText += "\nNo token info returned from backend for this key.";
          }
        } else {
          document.getElementById("notes").innerText += "\nBackend /api/balance returned error.";
        }
      } catch(e){
        document.getElementById("notes").innerText += "\nError fetching detail from backend: " + (e.message||e);
      }
    })();
  </script>
</body>
</html>